///////////////////////////////////////////////////////////////////////////////
//                                                                            /
// IAR C/C++ Compiler V8.20.1.40829 for 8051            23/May/2014  20:10:25 /
// Copyright 2004-2012 IAR Systems AB.                                        /
//                                                                            /
//    Core               =  plain                                             /
//    Code model         =  banked                                            /
//    Data model         =  large                                             /
//    Calling convention =  xdata reentrant                                   /
//    Constant location  =  data_rom                                          /
//    Dptr setup         =  1,16                                              /
//                                                                            /
//    Source file        =  D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\common\cc2540\OnBoard.c                        /
//    Command line       =  -f D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\config\buildCo /
//                          mponents.cfg (-DBROADCASTER_CFG=0x01              /
//                          -DOBSERVER_CFG=0x02 -DPERIPHERAL_CFG=0x04         /
//                          -DCENTRAL_CFG=0x08 -DADV_NCONN_CFG=0x01           /
//                          -DADV_CONN_CFG=0x02 -DSCAN_CFG=0x04               /
//                          -DINIT_CFG=0x08 -DADV_CFG=ADV_NCONN_CFG+ADV_CONN_ /
//                          CFG -DLINK_CFG=ADV_CONN_CFG+INIT_CFG              /
//                          -DFULL_CFG=INIT_CFG+SCAN_CFG+ADV_NCONN_CFG+ADV_CO /
//                          NN_CFG) -f D:\NTHU\¬ã¨s\Important\ThesisCode\Code /
//                          \GitLabCloud\NewEcoExec\codegenerator\Device\EcoB /
//                          T\Project\ble\CodeGenerator\CC2540DB\buildConfig. /
//                          cfg (-DHOST_CONFIG=PERIPHERAL_CFG                 /
//                          -DGAP_PRIVACY_RECONNECT)                          /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\common\cc2540\OnBoard.c -D INT_HEAP_LEN=900    /
//                          -D HALNODEBUG -D OSAL_CBTIMER_NUM_TASKS=1 -D      /
//                          HAL_AES_DMA=TRUE -D HAL_DMA=TRUE -D               /
//                          xPOWER_SAVING -D xPLUS_BROADCASTER -D             /
//                          HAL_LCD=FALSE -D HAL_LED=TRUE -D HAL_ADC=TRUE     /
//                          -lB D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLab /
//                          Cloud\NewEcoExec\codegenerator\Device\EcoBT\Proje /
//                          ct\ble\CodeGenerator\CC2540DB\CC2540\List\ -o     /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\CC2540\Obj\ -e --debug  /
//                          --core=plain --dptr=16,1 --data_model=large       /
//                          --code_model=banked --calling_convention=xdata_re /
//                          entrant --place_constants=data_rom                /
//                          --nr_virtual_regs 16 -I                           /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\common\ -I        /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\include\ -I       /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          hal\include\ -I D:\NTHU\¬ã¨s\Important\ThesisCode /
//                          \Code\GitLabCloud\NewEcoExec\codegenerator\Device /
//                          \EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\. /
//                          .\..\Components\hal\target\CC2540EB\ -I           /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          osal\include\ -I D:\NTHU\¬ã¨s\Important\ThesisCod /
//                          e\Code\GitLabCloud\NewEcoExec\codegenerator\Devic /
//                          e\EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\ /
//                          ..\..\Components\services\saddr\ -I               /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\include\ -I D:\NTHU\¬ã¨s\Important\ThesisCode /
//                          \Code\GitLabCloud\NewEcoExec\codegenerator\Device /
//                          \EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\. /
//                          .\..\Components\ble\controller\phy\ -I            /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\controller\include\ -I                        /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\hci\ -I D:\NTHU\¬ã¨s\Important\ThesisCode\Cod /
//                          e\GitLabCloud\NewEcoExec\codegenerator\Device\Eco /
//                          BT\Project\ble\CodeGenerator\CC2540DB\..\..\..\.. /
//                          \Components\ble\host\ -I                          /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\common\cc2540\    /
//                          -I D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\common\npi\npi /
//                          _np\ -I D:\NTHU\¬ã¨s\Important\ThesisCode\Code\Gi /
//                          tLabCloud\NewEcoExec\codegenerator\Device\EcoBT\P /
//                          roject\ble\CodeGenerator\CC2540DB\..\..\Profiles\ /
//                          Roles\ -I D:\NTHU\¬ã¨s\Important\ThesisCode\Code\ /
//                          GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT /
//                          \Project\ble\CodeGenerator\CC2540DB\..\..\Profile /
//                          s\SimpleProfile\ -I D:\NTHU\¬ã¨s\Important\Thesis /
//                          Code\Code\GitLabCloud\NewEcoExec\codegenerator\De /
//                          vice\EcoBT\Project\ble\CodeGenerator\CC2540DB\..\ /
//                          ..\Profiles\DevInfo\ -I                           /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\Profiles\Accelero /
//                          meter\ -I D:\NTHU\¬ã¨s\Important\ThesisCode\Code\ /
//                          GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT /
//                          \Project\ble\CodeGenerator\CC2540DB\..\..\Profile /
//                          s\EcoExecGATTProfile\ -I                          /
//                          D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\Profiles\Batt\    /
//                          -I D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\Profiles\HIDDe /
//                          v\ -Ohz                                           /
//    List file          =  D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\CC2540\List\OnBoard.s51 /
//                                                                            /
//                                                                            /
///////////////////////////////////////////////////////////////////////////////

        NAME OnBoard

        RSEG DOVERLAY:DATA:NOROOT(0)
        RSEG IOVERLAY:IDATA:NOROOT(0)
        RSEG ISTACK:IDATA:NOROOT(0)
        RSEG PSTACK:XDATA:NOROOT(0)
        RSEG XSTACK:XDATA:NOROOT(0)

        EXTERN ?ALLOC_XSTACK8
        EXTERN ?BANKED_ENTER_XDATA
        EXTERN ?BANKED_LEAVE_XDATA
        EXTERN ?BDISPATCH
        EXTERN ?BRET
        EXTERN ?DEALLOC_XSTACK8
        EXTERN ?US_DIV_MOD
        EXTERN ?V0
        EXTERN ?XSP
        EXTERN __INIT_XDATA_I
        EXTERN __INIT_XDATA_Z

        PUBLIC ??InitBoard?relay
        PUBLIC ??OnBoard_KeyCallback?relay
        PUBLIC ??OnBoard_SendKeys?relay
        PUBLIC ??Onboard_rand?relay
        PUBLIC ??RegisterForKeys?relay
        PUBLIC ??_itoa?relay
        PUBLIC ??appForceBoot?relay
        PUBLIC InitBoard
        PUBLIC OnBoard_KeyCallback
        PUBLIC OnBoard_SendKeys
        PUBLIC OnboardKeyIntEnable
        PUBLIC Onboard_rand
        PUBLIC Onboard_soft_reset
        PUBLIC RegisterForKeys
        PUBWEAK _A_IEN0
        PUBLIC _itoa
        PUBLIC appForceBoot

HalKeyConfig        SYMBOL "HalKeyConfig"
??HalKeyConfig?relay SYMBOL "?relay", HalKeyConfig
HalLedSet           SYMBOL "HalLedSet"
??HalLedSet?relay   SYMBOL "?relay", HalLedSet
LL_PseudoRand       SYMBOL "LL_PseudoRand"
??LL_PseudoRand?relay SYMBOL "?relay", LL_PseudoRand
osal_int_disable    SYMBOL "osal_int_disable"
??osal_int_disable?relay SYMBOL "?relay", osal_int_disable
osal_msg_allocate   SYMBOL "osal_msg_allocate"
??osal_msg_allocate?relay SYMBOL "?relay", osal_msg_allocate
osal_msg_send       SYMBOL "osal_msg_send"
??osal_msg_send?relay SYMBOL "?relay", osal_msg_send
InitBoard           SYMBOL "InitBoard"
??InitBoard?relay   SYMBOL "?relay", InitBoard
OnBoard_KeyCallback SYMBOL "OnBoard_KeyCallback"
??OnBoard_KeyCallback?relay SYMBOL "?relay", OnBoard_KeyCallback
OnBoard_SendKeys    SYMBOL "OnBoard_SendKeys"
??OnBoard_SendKeys?relay SYMBOL "?relay", OnBoard_SendKeys
Onboard_rand        SYMBOL "Onboard_rand"
??Onboard_rand?relay SYMBOL "?relay", Onboard_rand
RegisterForKeys     SYMBOL "RegisterForKeys"
??RegisterForKeys?relay SYMBOL "?relay", RegisterForKeys
_itoa               SYMBOL "_itoa"
??_itoa?relay       SYMBOL "?relay", _itoa
appForceBoot        SYMBOL "appForceBoot"
??appForceBoot?relay SYMBOL "?relay", appForceBoot

        EXTERN ??HalKeyConfig?relay
        EXTERN ??HalLedSet?relay
        EXTERN ??LL_PseudoRand?relay
        EXTERN ??osal_int_disable?relay
        EXTERN ??osal_msg_allocate?relay
        EXTERN ??osal_msg_send?relay
        EXTERN HalKeyConfig
        EXTERN HalLedSet
        EXTERN LL_PseudoRand
        EXTERN osal_int_disable
        EXTERN osal_msg_allocate
        EXTERN osal_msg_send

// D:\NTHU\¬ã¨s\Important\ThesisCode\Code\GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT\Project\ble\common\cc2540\OnBoard.c
//    1 /**************************************************************************************************
//    2   Filename:       OnBoard.c
//    3   Revised:        $Date: 2008-03-18 15:14:17 -0700 (Tue, 18 Mar 2008) $
//    4   Revision:       $Revision: 16604 $
//    5 
//    6   Description:    This file contains the UI and control for the
//    7                   peripherals on the EVAL development board
//    8   Notes:          This file targets the Chipcon CC2430DB/CC2430EB
//    9 
//   10 
//   11   Copyright 2005-2012 Texas Instruments Incorporated. All rights reserved.
//   12 
//   13   IMPORTANT: Your use of this Software is limited to those specific rights
//   14   granted under the terms of a software license agreement between the user
//   15   who downloaded the software, his/her employer (which must be your employer)
//   16   and Texas Instruments Incorporated (the "License").  You may not use this
//   17   Software unless you agree to abide by the terms of the License. The License
//   18   limits your use, and you acknowledge, that the Software may not be modified,
//   19   copied or distributed unless embedded on a Texas Instruments microcontroller
//   20   or used solely and exclusively in conjunction with a Texas Instruments radio
//   21   frequency transceiver, which is integrated into your product.  Other than for
//   22   the foregoing purpose, you may not use, reproduce, copy, prepare derivative
//   23   works of, modify, distribute, perform, display or sell this Software and/or
//   24   its documentation for any purpose.
//   25 
//   26   YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
//   27   PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
//   28   INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
//   29   NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
//   30   TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
//   31   NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
//   32   LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
//   33   INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
//   34   OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
//   35   OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
//   36   (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
//   37 
//   38   Should you have any questions regarding your right to use this Software,
//   39   contact Texas Instruments Incorporated at www.TI.com.
//   40 **************************************************************************************************/
//   41 
//   42 /*********************************************************************
//   43  * INCLUDES
//   44  */
//   45 #include "bcomdef.h"
//   46 #include "OnBoard.h"

        ASEGN SFR_AN:DATA:NOROOT,0a8H
// union <unnamed> volatile __sfr _A_IEN0
_A_IEN0:
        DATA8
        DS 1
//   47 #include "OSAL.h"
//   48 #include "OnBoard.h"
//   49 
//   50 #include "hal_led.h"
//   51 #include "hal_key.h"
//   52 
//   53 
//   54 /*********************************************************************
//   55  * MACROS
//   56  */
//   57 
//   58 /*********************************************************************
//   59  * CONSTANTS
//   60  */
//   61 
//   62 // Task ID not initialized
//   63 #define NO_TASK_ID 0xFF
//   64 
//   65 
//   66 /*********************************************************************
//   67  * TYPEDEFS
//   68  */
//   69 
//   70 /*********************************************************************
//   71  * GLOBAL VARIABLES
//   72  */

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
//   73 uint8 OnboardKeyIntEnable;
OnboardKeyIntEnable:
        DS 1
        REQUIRE __INIT_XDATA_Z
//   74 
//   75 
//   76 /*********************************************************************
//   77  * EXTERNAL VARIABLES
//   78  */
//   79 
//   80 /*********************************************************************
//   81  * EXTERNAL FUNCTIONS
//   82  */
//   83 extern uint8 LL_PseudoRand( uint8 *randData, uint8 dataLen );
//   84 
//   85 #if   defined FEATURE_ABL
//   86 #include "..\..\util\ABL\app\sbl_app.c"
//   87 #elif defined FEATURE_SBL
//   88 #include "..\..\util\SBL\app\sbl_app.c"
//   89 #elif defined FEATURE_EBL
//   90 #include "..\..\util\EBL\app\sbl_app.c"
//   91 #elif defined FEATURE_UBL_MSD
//   92 #include "..\..\util\UBL\soc_8051\usb_msd\app\ubl_app.c"
//   93 #else
//   94 void appForceBoot(void);
//   95 #endif
//   96 
//   97 /*********************************************************************
//   98  * LOCAL VARIABLES
//   99  */
//  100 
//  101 // Registered keys task ID, initialized to NOT USED.

        RSEG XDATA_I:XDATA:NOROOT(0)
//  102 static uint8 registeredKeysTaskID = NO_TASK_ID;
registeredKeysTaskID:
        DATA8
        DS 1
        REQUIRE `?<Initializer for registeredKeysTaskID>`
        REQUIRE __INIT_XDATA_I
//  103 
//  104 /*********************************************************************
//  105  * @fn      InitBoard()
//  106  * @brief   Initialize the CC2540DB Board Peripherals
//  107  * @param   level: COLD,WARM,READY
//  108  * @return  None
//  109  */

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  110 void InitBoard( uint8 level )
InitBoard:
        CODE
//  111 {
        MOV     A,#-0x9
        LCALL   ?BANKED_ENTER_XDATA
        ; Saved register size: 9
        ; Auto size: 0
        MOV     A,R1
//  112   if ( level == OB_COLD )
        JNZ     ??InitBoard_0
//  113   {
//  114     // Interrupts off
//  115     osal_int_disable( INTS_ALL );
        ; Setup parameters for call to function osal_int_disable
        MOV     R1,#-0x1
        LCALL   ??osal_int_disable?relay
//  116     // Turn all LEDs off
//  117     HalLedSet( HAL_LED_ALL, HAL_LED_MODE_OFF );
        ; Setup parameters for call to function HalLedSet
        MOV     R2,#0x0
        MOV     R1,#0xf
        LCALL   ??HalLedSet?relay
        SJMP    ??InitBoard_1
//  118     // Check for Brown-Out reset
//  119 //    ChkReset();
//  120   }
//  121   else  // !OB_COLD
//  122   {
//  123     /* Initialize Key stuff */
//  124     OnboardKeyIntEnable = HAL_KEY_INTERRUPT_ENABLE;
??InitBoard_0:
        MOV     DPTR,#OnboardKeyIntEnable
        MOV     A,#0x1
        MOVX    @DPTR,A
//  125     //OnboardKeyIntEnable = HAL_KEY_INTERRUPT_DISABLE;
//  126     HalKeyConfig( OnboardKeyIntEnable, OnBoard_KeyCallback);
        ; Setup parameters for call to function HalKeyConfig
        MOV     R2,#??OnBoard_KeyCallback?relay & 0xff
        MOV     R3,#(??OnBoard_KeyCallback?relay >> 8) & 0xff
        MOV     R1,A
        LCALL   ??HalKeyConfig?relay
//  127   }
//  128 }
??InitBoard_1:
        REQUIRE ?Subroutine0
        ; // Fall through to label ?Subroutine0

        RSEG BANKED_CODE:CODE:NOROOT(0)
?Subroutine0:
        MOV     R7,#0x1
        LJMP    ?BANKED_LEAVE_XDATA
//  129 
//  130 /*********************************************************************
//  131  * @fn        Onboard_rand
//  132  *
//  133  * @brief    Random number generator
//  134  *
//  135  * @param   none
//  136  *
//  137  * @return  uint16 - new random number
//  138  *
//  139  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  140 uint16 Onboard_rand( void )
Onboard_rand:
        CODE
//  141 {
        PUSH    DPL
        PUSH    DPH
        ; Saved register size: 2
        ; Auto size: 2
        MOV     A,#-0x2
        LCALL   ?ALLOC_XSTACK8
//  142   uint16 randNum;
//  143 
//  144   LL_PseudoRand( (uint8 *)&randNum, 2 );
        ; Setup parameters for call to function LL_PseudoRand
        MOV     R1,#0x2
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOV     R2,DPL
        MOV     R3,DPH
        LCALL   ??LL_PseudoRand?relay
//  145 
//  146   return ( randNum );
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     R2,A
        INC     DPTR
        MOVX    A,@DPTR
        MOV     R3,A
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
        REQUIRE ?Subroutine1
        ; // Fall through to label ?Subroutine1
//  147 }

        RSEG BANKED_CODE:CODE:NOROOT(0)
?Subroutine1:
        POP     DPH
        POP     DPL
        LJMP    ?BRET
//  148 
//  149 /*********************************************************************
//  150  * @fn      _itoa
//  151  *
//  152  * @brief   convert a 16bit number to ASCII
//  153  *
//  154  * @param   num -
//  155  *          buf -
//  156  *          radix -
//  157  *
//  158  * @return  void
//  159  *
//  160  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  161 void _itoa(uint16 num, uint8 *buf, uint8 radix)
_itoa:
        CODE
//  162 {
        MOV     A,#-0x10
        LCALL   ?BANKED_ENTER_XDATA
        ; Saved register size: 16
        ; Auto size: 5
        MOV     A,#-0x5
        LCALL   ?ALLOC_XSTACK8
        MOV     A,R2
        MOV     R6,A
        MOV     A,R3
        MOV     R7,A
        MOV     ?V0 + 0,R4
        MOV     ?V0 + 1,R5
//  163   char c,i;
//  164   uint8 *p, rst[5];
//  165 
//  166   p = rst;
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOV     R4,DPL
        MOV     R5,DPH
//  167   for ( i=0; i<5; i++,p++ )
        MOV     ?V0 + 5,#0x0
        MOV     DPL,R1
        MOV     ?V0 + 2,DPL
        MOV     ?V0 + 3,#0x0
//  168   {
//  169     c = num % radix;  // Isolate a digit
??_itoa_0:
        MOV     A,R6
        MOV     R0,A
        MOV     A,R7
        MOV     R1,A
        MOV     R2,?V0 + 2
        MOV     R3,?V0 + 3
        LCALL   ?US_DIV_MOD
        MOV     A,R2
//  170     *p = c + (( c < 10 ) ? '0' : '7');  // Convert to Ascii
        SUBB    A,#0xa
        JNC     ??_itoa_1
        MOV     R0,#0x30
        SJMP    ??_itoa_2
??_itoa_1:
        MOV     R0,#0x37
??_itoa_2:
        MOV     A,R0
        ADD     A,R2
        MOV     DPL,R4
        MOV     DPH,R5
        MOVX    @DPTR,A
//  171     num /= radix;
        MOV     A,R6
        MOV     R0,A
        MOV     A,R7
        MOV     R1,A
        MOV     R2,?V0 + 2
        MOV     R3,?V0 + 3
        LCALL   ?US_DIV_MOD
        MOV     ?V0 + 6,R0
        MOV     ?V0 + 7,R1
        MOV     R6,?V0 + 6
        MOV     R7,?V0 + 7
//  172     if ( !num )
        MOV     A,R6
        ORL     A,R7
        JZ      ??_itoa_3
//  173       break;
//  174   }
        INC     ?V0 + 5
        INC     DPTR
        MOV     R4,DPL
        MOV     R5,DPH
        MOV     A,?V0 + 5
        SUBB    A,#0x5
        JC      ??_itoa_0
//  175 
//  176   for ( c=0 ; c<=i; c++ )
??_itoa_3:
        MOV     R2,#0x0
//  177     *buf++ = *p--;  // Reverse character order
??_itoa_4:
        MOV     DPL,R4
        MOV     DPH,R5
        MOVX    A,@DPTR
        MOV     DPL,?V0 + 0
        MOV     DPH,?V0 + 1
        MOVX    @DPTR,A
        MOV     A,R4
        ADD     A,#-0x1
        DEC     R4
        MOV     A,R5
        ADDC    A,#-0x1
        MOV     R5,A
        INC     DPTR
        MOV     ?V0 + 0,DPL
        MOV     ?V0 + 1,DPH
        INC     R2
        MOV     A,?V0 + 5
        CLR     C
        SUBB    A,R2
        JNC     ??_itoa_4
//  178 
//  179   *buf = '\0';
        CLR     A
        MOVX    @DPTR,A
//  180 }
        MOV     A,#0x5
        LCALL   ?DEALLOC_XSTACK8
        MOV     R7,#0x8
        LJMP    ?BANKED_LEAVE_XDATA
//  181 
//  182 /*********************************************************************
//  183  *                        "Keyboard" Support
//  184  *********************************************************************/
//  185 
//  186 /*********************************************************************
//  187  * Keyboard Register function
//  188  *
//  189  * The keyboard handler is setup to send all keyboard changes to
//  190  * one task (if a task is registered).
//  191  *
//  192  * If a task registers, it will get all the keys. You can change this
//  193  * to register for individual keys.
//  194  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  195 uint8 RegisterForKeys( uint8 task_id )
RegisterForKeys:
        CODE
//  196 {
        PUSH    DPL
        PUSH    DPH
        ; Saved register size: 2
        ; Auto size: 0
        MOV     A,R1
        MOV     R0,A
//  197   // Allow only the first task
//  198   if ( registeredKeysTaskID == NO_TASK_ID )
        MOV     DPTR,#registeredKeysTaskID
        MOVX    A,@DPTR
        CPL     A
        JNZ     ??RegisterForKeys_0
//  199   {
//  200     registeredKeysTaskID = task_id;
        MOV     A,R0
        MOVX    @DPTR,A
//  201     return ( true );
        MOV     R1,#0x1
        SJMP    ??RegisterForKeys_1
//  202   }
//  203   else
//  204     return ( false );
??RegisterForKeys_0:
        MOV     R1,#0x0
??RegisterForKeys_1:
        LJMP    ?Subroutine1 & 0xFFFF
//  205 }
//  206 
//  207 /*********************************************************************
//  208  * @fn      OnBoard_SendKeys
//  209  *
//  210  * @brief   Send "Key Pressed" message to application.
//  211  *
//  212  * @param   keys  - keys that were pressed
//  213  *          state - shifted
//  214  *
//  215  * @return  status
//  216  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  217 uint8 OnBoard_SendKeys( uint8 keys, uint8 state )
OnBoard_SendKeys:
        CODE
//  218 {
        MOV     A,#-0xa
        LCALL   ?BANKED_ENTER_XDATA
        ; Saved register size: 10
        ; Auto size: 0
        MOV     A,R1
        MOV     R6,A
        MOV     A,R2
        MOV     R7,A
//  219   keyChange_t *msgPtr;
//  220 
//  221   if ( registeredKeysTaskID != NO_TASK_ID )
        MOV     DPTR,#registeredKeysTaskID
        MOVX    A,@DPTR
        CPL     A
        JZ      ??OnBoard_SendKeys_0
//  222   {
//  223     // Send the address to the task
//  224     msgPtr = (keyChange_t *)osal_msg_allocate( sizeof(keyChange_t) );
        ; Setup parameters for call to function osal_msg_allocate
        MOV     R2,#0x4
        MOV     R3,#0x0
        LCALL   ??osal_msg_allocate?relay
//  225     if ( msgPtr )
        MOV     A,R2
        ORL     A,R3
        JZ      ??OnBoard_SendKeys_1
//  226     {
//  227       msgPtr->hdr.event = KEY_CHANGE;
        MOV     DPL,R2
        MOV     DPH,R3
        MOV     A,#-0x40
        MOVX    @DPTR,A
//  228       msgPtr->state = state;
        MOV     A,R7
        INC     DPTR
        INC     DPTR
        MOVX    @DPTR,A
//  229       msgPtr->keys = keys;
        MOV     A,R6
        MOV     DPL,R2
        MOV     DPH,R3
        INC     DPTR
        INC     DPTR
        INC     DPTR
        MOVX    @DPTR,A
//  230 
//  231       osal_msg_send( registeredKeysTaskID, (uint8 *)msgPtr );
        ; Setup parameters for call to function osal_msg_send
        MOV     DPTR,#registeredKeysTaskID
        MOVX    A,@DPTR
        MOV     R1,A
        LCALL   ??osal_msg_send?relay
//  232     }
//  233     return ( SUCCESS );
??OnBoard_SendKeys_1:
        MOV     R1,#0x0
        SJMP    ??OnBoard_SendKeys_2
//  234   }
//  235   else
//  236     return ( FAILURE );
??OnBoard_SendKeys_0:
        MOV     R1,#0x1
??OnBoard_SendKeys_2:
        MOV     R7,#0x2
        LJMP    ?BANKED_LEAVE_XDATA
//  237 }
//  238 
//  239 /*********************************************************************
//  240  * @fn      OnBoard_KeyCallback
//  241  *
//  242  * @brief   Callback service for keys
//  243  *
//  244  * @param   keys  - keys that were pressed
//  245  *          state - shifted
//  246  *
//  247  * @return  void
//  248  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  249 void OnBoard_KeyCallback ( uint8 keys, uint8 state )
OnBoard_KeyCallback:
        CODE
//  250 {
        MOV     A,#-0x9
        LCALL   ?BANKED_ENTER_XDATA
        ; Saved register size: 9
        ; Auto size: 0
        MOV     A,R1
        MOV     R6,A
//  251   uint8 shift;
//  252   (void)state;
//  253 
//  254   // shift key (S1) is used to generate key interrupt
//  255   // applications should not use S1 when key interrupt is enabled
//  256   shift = (OnboardKeyIntEnable == HAL_KEY_INTERRUPT_ENABLE) ? false : ((keys & HAL_KEY_SW_6) ? true : false);
        MOV     DPTR,#OnboardKeyIntEnable
        MOVX    A,@DPTR
        XRL     A,#0x1
        JNZ     ??OnBoard_KeyCallback_0
        MOV     R2,#0x0
        SJMP    ??OnBoard_KeyCallback_1
??OnBoard_KeyCallback_0:
        MOV     A,R6
        MOV     C,0xE0 /* A   */.5
        JNC     ??OnBoard_KeyCallback_2
        SETB    B.0
        SJMP    ??OnBoard_KeyCallback_3
??OnBoard_KeyCallback_2:
        CLR     B.0
??OnBoard_KeyCallback_3:
        MOV     C,B.0
        CLR     A
        RLC     A
        MOV     R2,A
//  257 
//  258   if ( OnBoard_SendKeys( keys, shift ) != SUCCESS )
??OnBoard_KeyCallback_1:
        ; Setup parameters for call to function OnBoard_SendKeys
        LCALL   ??OnBoard_SendKeys?relay
//  259   {
//  260     // Process SW1 here
//  261     if ( keys & HAL_KEY_SW_1 )  // Switch 1
//  262     {
//  263     }
//  264     // Process SW2 here
//  265     if ( keys & HAL_KEY_SW_2 )  // Switch 2
//  266     {
//  267     }
//  268     // Process SW3 here
//  269     if ( keys & HAL_KEY_SW_3 )  // Switch 3
//  270     {
//  271     }
//  272     // Process SW4 here
//  273     if ( keys & HAL_KEY_SW_4 )  // Switch 4
//  274     {
//  275     }
//  276     // Process SW5 here
//  277     if ( keys & HAL_KEY_SW_5 )  // Switch 5
//  278     {
//  279     }
//  280     // Process SW6 here
//  281     if ( keys & HAL_KEY_SW_6 )  // Switch 6
//  282     {
//  283     }
//  284   }
//  285 
//  286   /* If any key is currently pressed down and interrupt
//  287      is still enabled, disable interrupt and switch to polling */
//  288   if( keys != 0 )
        MOV     A,R6
        MOV     DPTR,#OnboardKeyIntEnable
        JZ      ??OnBoard_KeyCallback_4
//  289   {
//  290     if( OnboardKeyIntEnable == HAL_KEY_INTERRUPT_ENABLE )
        MOVX    A,@DPTR
        XRL     A,#0x1
        JNZ     ??OnBoard_KeyCallback_5
//  291     {
//  292       OnboardKeyIntEnable = HAL_KEY_INTERRUPT_DISABLE;
        CLR     A
        SJMP    ??OnBoard_KeyCallback_6
//  293       HalKeyConfig( OnboardKeyIntEnable, OnBoard_KeyCallback);
//  294     }
//  295   }
//  296   /* If no key is currently pressed down and interrupt
//  297      is disabled, enable interrupt and turn off polling */
//  298   else
//  299   {
//  300     if( OnboardKeyIntEnable == HAL_KEY_INTERRUPT_DISABLE )
??OnBoard_KeyCallback_4:
        MOVX    A,@DPTR
        JNZ     ??OnBoard_KeyCallback_5
//  301     {
//  302       OnboardKeyIntEnable = HAL_KEY_INTERRUPT_ENABLE;
        MOV     A,#0x1
??OnBoard_KeyCallback_6:
        MOVX    @DPTR,A
//  303       HalKeyConfig( OnboardKeyIntEnable, OnBoard_KeyCallback);
        ; Setup parameters for call to function HalKeyConfig
        MOV     R2,#??OnBoard_KeyCallback?relay & 0xff
        MOV     R3,#(??OnBoard_KeyCallback?relay >> 8) & 0xff
        MOV     R1,A
        LCALL   ??HalKeyConfig?relay
//  304     }
//  305   }
//  306 }
??OnBoard_KeyCallback_5:
        LJMP    ?Subroutine0 & 0xFFFF
//  307 
//  308 /*********************************************************************
//  309  * @fn      Onboard_soft_reset
//  310  *
//  311  * @brief   Effect a soft reset.
//  312  *
//  313  * @param   none
//  314  *
//  315  * @return  none
//  316  *
//  317  *********************************************************************/

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  318 __near_func void Onboard_soft_reset( void )
Onboard_soft_reset:
        CODE
//  319 {
        ; Saved register size: 0
        ; Auto size: 0
//  320   HAL_DISABLE_INTERRUPTS();
        CLR     0xa8.7
//  321   asm("LJMP 0x0");
        LJMP 0x0
//  322 }
        RET
        REQUIRE _A_IEN0
//  323 
//  324 #if   defined FEATURE_ABL
//  325 #elif defined FEATURE_SBL
//  326 #elif defined FEATURE_EBL
//  327 #elif defined FEATURE_UBL_MSD
//  328 #else
//  329 /*********************************************************************
//  330  * @fn      appForceBoot
//  331  *
//  332  * @brief   Common force-boot function for the HCI library to invoke.
//  333  *
//  334  * @param   none
//  335  *
//  336  * @return  void
//  337  *********************************************************************/

        RSEG BANKED_CODE:CODE:NOROOT(0)
//  338 void appForceBoot(void)
appForceBoot:
        CODE
//  339 {
        ; Saved register size: 0
        ; Auto size: 0
//  340   // Dummy function for HCI library that cannot depend on the SBL build defines.
//  341 }
        LJMP    ?BRET

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for registeredKeysTaskID>`:
        DATA8
        DB 255

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??InitBoard?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    InitBoard

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??Onboard_rand?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    Onboard_rand

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??_itoa?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    _itoa

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??RegisterForKeys?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    RegisterForKeys

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??OnBoard_SendKeys?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    OnBoard_SendKeys

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??OnBoard_KeyCallback?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    OnBoard_KeyCallback

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??appForceBoot?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    appForceBoot

        END
//  342 #endif
//  343 
//  344 /*********************************************************************
//  345 *********************************************************************/
// 
// 402 bytes in segment BANKED_CODE
//  42 bytes in segment BANK_RELAYS
//   6 bytes in segment NEAR_CODE
//   1 byte  in segment SFR_AN
//   1 byte  in segment XDATA_I
//   1 byte  in segment XDATA_ID
//   1 byte  in segment XDATA_Z
// 
// 451 bytes of CODE  memory
//   0 bytes of DATA  memory (+ 1 byte shared)
//   2 bytes of XDATA memory
//
//Errors: none
//Warnings: none
