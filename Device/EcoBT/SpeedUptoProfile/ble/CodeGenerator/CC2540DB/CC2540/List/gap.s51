///////////////////////////////////////////////////////////////////////////////
//                                                                            /
// IAR C/C++ Compiler V8.20.1.40829 for 8051            23/May/2014  20:10:27 /
// Copyright 2004-2012 IAR Systems AB.                                        /
//                                                                            /
//    Core               =  plain                                             /
//    Code model         =  banked                                            /
//    Data model         =  large                                             /
//    Calling convention =  xdata reentrant                                   /
//    Constant location  =  data_rom                                          /
//    Dptr setup         =  1,16                                              /
//                                                                            /
//    Source file        =  D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\Profiles\Roles\gap.c                           /
//    Command line       =  -f D:\NTHU\研究\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\config\buildCo /
//                          mponents.cfg (-DBROADCASTER_CFG=0x01              /
//                          -DOBSERVER_CFG=0x02 -DPERIPHERAL_CFG=0x04         /
//                          -DCENTRAL_CFG=0x08 -DADV_NCONN_CFG=0x01           /
//                          -DADV_CONN_CFG=0x02 -DSCAN_CFG=0x04               /
//                          -DINIT_CFG=0x08 -DADV_CFG=ADV_NCONN_CFG+ADV_CONN_ /
//                          CFG -DLINK_CFG=ADV_CONN_CFG+INIT_CFG              /
//                          -DFULL_CFG=INIT_CFG+SCAN_CFG+ADV_NCONN_CFG+ADV_CO /
//                          NN_CFG) -f D:\NTHU\研究\Important\ThesisCode\Code /
//                          \GitLabCloud\NewEcoExec\codegenerator\Device\EcoB /
//                          T\Project\ble\CodeGenerator\CC2540DB\buildConfig. /
//                          cfg (-DHOST_CONFIG=PERIPHERAL_CFG                 /
//                          -DGAP_PRIVACY_RECONNECT)                          /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\Profiles\Roles\gap.c -D INT_HEAP_LEN=900 -D    /
//                          HALNODEBUG -D OSAL_CBTIMER_NUM_TASKS=1 -D         /
//                          HAL_AES_DMA=TRUE -D HAL_DMA=TRUE -D               /
//                          xPOWER_SAVING -D xPLUS_BROADCASTER -D             /
//                          HAL_LCD=FALSE -D HAL_LED=TRUE -D HAL_ADC=TRUE     /
//                          -lB D:\NTHU\研究\Important\ThesisCode\Code\GitLab /
//                          Cloud\NewEcoExec\codegenerator\Device\EcoBT\Proje /
//                          ct\ble\CodeGenerator\CC2540DB\CC2540\List\ -o     /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\CC2540\Obj\ -e --debug  /
//                          --core=plain --dptr=16,1 --data_model=large       /
//                          --code_model=banked --calling_convention=xdata_re /
//                          entrant --place_constants=data_rom                /
//                          --nr_virtual_regs 16 -I                           /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\common\ -I        /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\include\ -I       /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          hal\include\ -I D:\NTHU\研究\Important\ThesisCode /
//                          \Code\GitLabCloud\NewEcoExec\codegenerator\Device /
//                          \EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\. /
//                          .\..\Components\hal\target\CC2540EB\ -I           /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          osal\include\ -I D:\NTHU\研究\Important\ThesisCod /
//                          e\Code\GitLabCloud\NewEcoExec\codegenerator\Devic /
//                          e\EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\ /
//                          ..\..\Components\services\saddr\ -I               /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\include\ -I D:\NTHU\研究\Important\ThesisCode /
//                          \Code\GitLabCloud\NewEcoExec\codegenerator\Device /
//                          \EcoBT\Project\ble\CodeGenerator\CC2540DB\..\..\. /
//                          .\..\Components\ble\controller\phy\ -I            /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\controller\include\ -I                        /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\..\..\Components\ /
//                          ble\hci\ -I D:\NTHU\研究\Important\ThesisCode\Cod /
//                          e\GitLabCloud\NewEcoExec\codegenerator\Device\Eco /
//                          BT\Project\ble\CodeGenerator\CC2540DB\..\..\..\.. /
//                          \Components\ble\host\ -I                          /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\common\cc2540\    /
//                          -I D:\NTHU\研究\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\common\npi\npi /
//                          _np\ -I D:\NTHU\研究\Important\ThesisCode\Code\Gi /
//                          tLabCloud\NewEcoExec\codegenerator\Device\EcoBT\P /
//                          roject\ble\CodeGenerator\CC2540DB\..\..\Profiles\ /
//                          Roles\ -I D:\NTHU\研究\Important\ThesisCode\Code\ /
//                          GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT /
//                          \Project\ble\CodeGenerator\CC2540DB\..\..\Profile /
//                          s\SimpleProfile\ -I D:\NTHU\研究\Important\Thesis /
//                          Code\Code\GitLabCloud\NewEcoExec\codegenerator\De /
//                          vice\EcoBT\Project\ble\CodeGenerator\CC2540DB\..\ /
//                          ..\Profiles\DevInfo\ -I                           /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\Profiles\Accelero /
//                          meter\ -I D:\NTHU\研究\Important\ThesisCode\Code\ /
//                          GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT /
//                          \Project\ble\CodeGenerator\CC2540DB\..\..\Profile /
//                          s\EcoExecGATTProfile\ -I                          /
//                          D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\..\..\Profiles\Batt\    /
//                          -I D:\NTHU\研究\Important\ThesisCode\Code\GitLabC /
//                          loud\NewEcoExec\codegenerator\Device\EcoBT\Projec /
//                          t\ble\CodeGenerator\CC2540DB\..\..\Profiles\HIDDe /
//                          v\ -Ohz                                           /
//    List file          =  D:\NTHU\研究\Important\ThesisCode\Code\GitLabClou /
//                          d\NewEcoExec\codegenerator\Device\EcoBT\Project\b /
//                          le\CodeGenerator\CC2540DB\CC2540\List\gap.s51     /
//                                                                            /
//                                                                            /
///////////////////////////////////////////////////////////////////////////////

        NAME gap

        RSEG DOVERLAY:DATA:NOROOT(0)
        RSEG IOVERLAY:IDATA:NOROOT(0)
        RSEG ISTACK:IDATA:NOROOT(0)
        RSEG PSTACK:XDATA:NOROOT(0)
        RSEG XSTACK:XDATA:NOROOT(0)

        EXTERN ?BANKED_ENTER_XDATA
        EXTERN ?BANKED_LEAVE_XDATA
        EXTERN ?BDISPATCH
        EXTERN ?DEALLOC_XSTACK8
        EXTERN ?PUSH_XSTACK_I_TWO
        EXTERN ?V0
        EXTERN ?XSTACK_DISP0_8

        PUBLIC ??GAP_DeviceInit?relay
        PUBLIC GAP_DeviceInit

GAP_ParamsInit      SYMBOL "GAP_ParamsInit"
??GAP_ParamsInit?relay SYMBOL "?relay", GAP_ParamsInit
GAP_PeriDevMgrInit  SYMBOL "GAP_PeriDevMgrInit"
??GAP_PeriDevMgrInit?relay SYMBOL "?relay", GAP_PeriDevMgrInit
GAP_SecParamsInit   SYMBOL "GAP_SecParamsInit"
??GAP_SecParamsInit?relay SYMBOL "?relay", GAP_SecParamsInit
SM_ResponderInit    SYMBOL "SM_ResponderInit"
??SM_ResponderInit?relay SYMBOL "?relay", SM_ResponderInit
GAP_DeviceInit      SYMBOL "GAP_DeviceInit"
??GAP_DeviceInit?relay SYMBOL "?relay", GAP_DeviceInit

        EXTERN ??GAP_ParamsInit?relay
        EXTERN ??GAP_PeriDevMgrInit?relay
        EXTERN ??GAP_SecParamsInit?relay
        EXTERN ??SM_ResponderInit?relay
        EXTERN GAP_ParamsInit
        EXTERN GAP_PeriDevMgrInit
        EXTERN GAP_SecParamsInit
        EXTERN SM_ResponderInit

// D:\NTHU\研究\Important\ThesisCode\Code\GitLabCloud\NewEcoExec\codegenerator\Device\EcoBT\Project\ble\Profiles\Roles\gap.c
//    1 /*************************************************************************************************
//    2   Filename:       gap.c
//    3   Revised:        $Date: 2011-06-17 10:40:59 -0700 (Fri, 17 Jun 2011) $
//    4   Revision:       $Revision: 26366 $
//    5 
//    6   Description:    This file contains the GAP Configuration API.
//    7 
//    8 
//    9   Copyright 2011 Texas Instruments Incorporated. All rights reserved.
//   10 
//   11   IMPORTANT: Your use of this Software is limited to those specific rights
//   12   granted under the terms of a software license agreement between the user
//   13   who downloaded the software, his/her employer (which must be your employer)
//   14   and Texas Instruments Incorporated (the "License").  You may not use this
//   15   Software unless you agree to abide by the terms of the License. The License
//   16   limits your use, and you acknowledge, that the Software may not be modified,
//   17   copied or distributed unless embedded on a Texas Instruments microcontroller
//   18   or used solely and exclusively in conjunction with a Texas Instruments radio
//   19   frequency transceiver, which is integrated into your product.  Other than for
//   20   the foregoing purpose, you may not use, reproduce, copy, prepare derivative
//   21   works of, modify, distribute, perform, display or sell this Software and/or
//   22   its documentation for any purpose.
//   23 
//   24   YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
//   25   PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
//   26   INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
//   27   NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
//   28   TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
//   29   NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
//   30   LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
//   31   INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
//   32   OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
//   33   OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
//   34   (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
//   35 
//   36   Should you have any questions regarding your right to use this Software,
//   37   contact Texas Instruments Incorporated at www.TI.com.
//   38 **************************************************************************************************/
//   39 
//   40 #include "bcomdef.h"
//   41 #include "gap.h"
//   42 #include "sm.h"
//   43 
//   44 /*********************************************************************
//   45  * MACROS
//   46  */
//   47 
//   48 /*********************************************************************
//   49  * CONSTANTS
//   50  */
//   51 
//   52 /*********************************************************************
//   53  * GLOBAL VARIABLES
//   54  */
//   55 
//   56 /*********************************************************************
//   57  * EXTERNAL VARIABLES
//   58  */
//   59 
//   60 /*********************************************************************
//   61  * EXTERNAL FUNCTIONS
//   62  */
//   63 
//   64 /*********************************************************************
//   65  * LOCAL VARIABLES
//   66  */
//   67 
//   68 /*********************************************************************
//   69  * LOCAL FUNCTION PROTOTYPES
//   70  */
//   71 
//   72 /*********************************************************************
//   73  * API FUNCTIONS
//   74  */
//   75 
//   76 /*********************************************************************
//   77  * Called to setup the device.  Call just once.
//   78  *
//   79  * Public function defined in gap.h.
//   80  */

        RSEG BANKED_CODE:CODE:NOROOT(0)
//   81 bStatus_t GAP_DeviceInit(  uint8 taskID,
GAP_DeviceInit:
        CODE
//   82                            uint8 profileRole,
//   83                            uint8 maxScanResponses,
//   84                            uint8 *pIRK,
//   85                            uint8 *pSRK,
//   86                            uint32 *pSignCounter )
//   87 {
        MOV     A,#-0xf
        LCALL   ?BANKED_ENTER_XDATA
        ; Saved register size: 15
        ; Auto size: 0
        MOV     A,R4
        MOV     R6,A
        MOV     A,R5
        MOV     R7,A
        MOV     A,#0xf
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        MOV     ?V0 + 0,A
        INC     DPTR
        MOVX    A,@DPTR
        MOV     ?V0 + 1,A
        MOV     A,#0x11
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        MOV     ?V0 + 4,A
        INC     DPTR
        MOVX    A,@DPTR
        MOV     ?V0 + 5,A
//   88   bStatus_t stat = INVALIDPARAMETER;   // Return status
        MOV     ?V0 + 6,#0x2
//   89 
//   90   // Valid profile roles and supported combinations
//   91   switch ( profileRole )
        MOV     A,R2
        DEC     A
        JZ      ??GAP_DeviceInit_0
        ADD     A,#-0x3
        JNZ     ??GAP_DeviceInit_1
//   92   {
//   93     case GAP_PROFILE_BROADCASTER:
//   94       #if ( HOST_CONFIG & ( BROADCASTER_CFG | PERIPHERAL_CFG ) )
//   95       {
//   96         stat = SUCCESS;
//   97       }
//   98       #endif
//   99       break;
//  100 
//  101     case GAP_PROFILE_OBSERVER:
//  102       #if ( HOST_CONFIG & ( OBSERVER_CFG | CENTRAL_CFG ) )
//  103       {
//  104         stat = SUCCESS;
//  105       }
//  106       #endif
//  107       break;
//  108 
//  109     case GAP_PROFILE_PERIPHERAL:
//  110       #if ( HOST_CONFIG & PERIPHERAL_CFG )
//  111       {
//  112         stat = SUCCESS;
//  113       }
//  114       #endif
//  115       break;
//  116 
//  117     case GAP_PROFILE_CENTRAL:
//  118       #if ( HOST_CONFIG & CENTRAL_CFG )
//  119       {
//  120         stat = SUCCESS;
//  121       }
//  122       #endif
//  123       break;
//  124 
//  125     case (GAP_PROFILE_BROADCASTER | GAP_PROFILE_OBSERVER):
//  126       #if ( ( HOST_CONFIG & ( BROADCASTER_CFG | PERIPHERAL_CFG ) ) && \ 
//  127             ( HOST_CONFIG & ( OBSERVER_CFG | CENTRAL_CFG ) ) )
//  128       {
//  129         stat = SUCCESS;
//  130       }
//  131       #endif
//  132       break;
//  133 
//  134     case (GAP_PROFILE_PERIPHERAL | GAP_PROFILE_OBSERVER):
//  135       #if ( ( HOST_CONFIG & PERIPHERAL_CFG ) && \ 
//  136             ( HOST_CONFIG & ( OBSERVER_CFG | CENTRAL_CFG ) ) )
//  137       {
//  138         stat = SUCCESS;
//  139       }
//  140       #endif
//  141       break;
//  142 
//  143     case (GAP_PROFILE_CENTRAL | GAP_PROFILE_BROADCASTER):
//  144       #if ( ( HOST_CONFIG & CENTRAL_CFG ) && \ 
//  145             ( HOST_CONFIG & ( BROADCASTER_CFG | PERIPHERAL_CFG ) ) )
//  146       {
//  147         stat = SUCCESS;
//  148       }
//  149       #endif
//  150       break;
//  151 
//  152     // Invalid profile roles
//  153     default:
//  154       stat = INVALIDPARAMETER;
//  155       break;
//  156   }
//  157 
//  158   if ( stat == SUCCESS )
//  159   {
//  160     // Setup the device configuration parameters
//  161     stat = GAP_ParamsInit( taskID, profileRole );
??GAP_DeviceInit_0:
        ; Setup parameters for call to function GAP_ParamsInit
        LCALL   ??GAP_ParamsInit?relay
        MOV     A,R1
        MOV     ?V0 + 6,A
//  162     if ( stat == SUCCESS )
        JNZ     ??GAP_DeviceInit_1
//  163     {
//  164       #if ( HOST_CONFIG & ( CENTRAL_CFG | PERIPHERAL_CFG ) )
//  165       {
//  166         GAP_SecParamsInit( pIRK, pSRK, pSignCounter );
        ; Setup parameters for call to function GAP_SecParamsInit
        MOV     R0,#?V0 + 4
        LCALL   ?PUSH_XSTACK_I_TWO
        MOV     R4,?V0 + 0
        MOV     R5,?V0 + 1
        MOV     A,R6
        MOV     R2,A
        MOV     A,R7
        MOV     R3,A
        LCALL   ??GAP_SecParamsInit?relay
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
//  167       }
//  168       #endif
//  169 
//  170       #if ( HOST_CONFIG & ( CENTRAL_CFG | OBSERVER_CFG ) )
//  171       {
//  172         if ( (profileRole == GAP_PROFILE_BROADCASTER) ||
//  173              (profileRole == GAP_PROFILE_PERIPHERAL) )
//  174         {
//  175           maxScanResponses = 0; // Can't scan, so no need for responses. Force 0.
//  176         }
//  177 
//  178         // Initialize GAP Central Device Manager
//  179         VOID GAP_CentDevMgrInit( maxScanResponses );
//  180 
//  181         #if ( HOST_CONFIG & CENTRAL_CFG )
//  182         {
//  183           // Register GAP Central Connection processing functions
//  184           GAP_CentConnRegister();
//  185 
//  186           // Initialize SM Initiator
//  187           VOID SM_InitiatorInit();
//  188         }
//  189         #endif
//  190       }
//  191       #endif
//  192 
//  193       #if ( HOST_CONFIG & ( PERIPHERAL_CFG | BROADCASTER_CFG ) )
//  194       {
//  195         // Initialize GAP Peripheral Device Manager
//  196         VOID GAP_PeriDevMgrInit();
        ; Setup parameters for call to function GAP_PeriDevMgrInit
        LCALL   ??GAP_PeriDevMgrInit?relay
//  197 
//  198         #if ( HOST_CONFIG & PERIPHERAL_CFG )
//  199         {
//  200           // Initialize SM Responder
//  201           VOID SM_ResponderInit();
        ; Setup parameters for call to function SM_ResponderInit
        LCALL   ??SM_ResponderInit?relay
//  202         }
//  203         #endif
//  204       }
//  205       #endif
//  206     }
//  207   }
//  208 
//  209   return ( stat );
??GAP_DeviceInit_1:
        MOV     R1,?V0 + 6
        MOV     R7,#0x7
        LJMP    ?BANKED_LEAVE_XDATA
//  210 }

        RSEG BANK_RELAYS:CODE:REORDER:NOROOT(0)
??GAP_DeviceInit?relay:
        CODE
        LCALL   ?BDISPATCH
        DATA24
        DC24    GAP_DeviceInit

        END
//  211 
//  212 /*********************************************************************
//  213 *********************************************************************/
// 
// 86 bytes in segment BANKED_CODE
//  6 bytes in segment BANK_RELAYS
// 
// 92 bytes of CODE memory
//
//Errors: none
//Warnings: none
